---
title: "Untitled"
author: "Juliano Palacios-Abrantes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, results='hide', message=FALSE, echo = F}
library(MyFunctions)

packages <- c(
  "tidyverse",
  "cowplot",
  "wesanderson",
  "sf"
)

my_lib(packages)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)
```


# Get data for all

```{r get_data, eval = T}

# Future Oceans data
future_data <- my_path("R",name = "aggregated_data_all_spp.csv", read = T) 

# Hotspots data
hotspot_data <- my_path("D", name= "hotspots_data.csv", read = T)

# Sau map
sau_sf <- my_sf("SAU")

# 
# as.data.frame(sau_sf) %>% select(name) %>% View()


```

## Gulf of Guinea

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Gulf of Guinea")


```

Cameroon, Congo, DRC, Equatorial Guinea, Gabon, Nigeria, Sao Tome & Principe


```{r g_guinea_data, eval = T, echo = T}

# Oceans future data
g_guinea <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_name
  )

length(unique(g_guinea$eez_name))

# SAU shapefile data
g_guinea_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(g_guinea_sf$name)


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "red"
)


g_guinea_line <- g_guinea %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(data = g_guinea,
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(data = g_guinea,
              aes(
                x = as.numeric(year),
                ymax = per_change_rm+sd_per_change,
                ymin = per_change_rm-sd_per_change,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual(values = color_pallet) +
  scale_fill_manual(values = color_pallet) +
  scale_y_continuous(limits =c(-100,50),
                     breaks = c(-100,-50,0,50)
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = g_guinea_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

g_guinea_2050 <- g_guinea %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(g_guinea_2050$change,na.rm = T))
max_value <- ceiling(max(g_guinea_2050$change,na.rm = T))


g_guinea_map <- 
  g_guinea_sf %>% 
  left_join(g_guinea_2050,
            by = "name") %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  geom_sf_label(aes(label = name, fill = change), size = 2, color = "white") +
  # scale_color_viridis_b("% Change Relative to Historical Value\n(All species aggregated)") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,10),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(0,14),
           ylim = c(-7,7)) +
  facet_wrap(~ssp,
             labeller = labeller(ssp = c("126" = "SSP1-2.6",
                                         "585" = "SSP5-8.5"))
             )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = g_guinea_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

g_guinea_panel <-
  ggdraw() +
  draw_plot(g_guinea_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(g_guinea_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)


panel_name <- paste0(selected_hotspot$hotspot,"_panel.png")[1] 

ggsave(plot = g_guinea_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )



```

## West Africa

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "West Africa")

print(unique(selected_hotspot$eez_name))

```

"The Gambia"      "Senegal"         "Guinea-Bissau"   "Guinea"          "Morocco (South)"


```{r w_africa_data, eval = T, echo = T}

# Oceans future data
w_africa <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_name
  )

length(unique(w_africa$eez_name))

# SAU shapefile data
w_africa_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(w_africa_sf$name)
length(unique(w_africa_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "red"
)


w_africa_line <- w_africa %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,100),
                     breaks = seq(-100,100,25),
                     labels = c("< -100",seq(-75,75,25),">100")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = w_africa_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

w_africa_2050 <- w_africa %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(w_africa_2050$change,na.rm = T))
max_value <- ceiling(max(w_africa_2050$change,na.rm = T))


w_africa_map <- 
  w_africa_sf %>% 
  left_join(w_africa_2050,
            by = "name") %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  geom_sf_label(aes(label = name, fill = change), size = 2, color = "white") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,1),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(-25,-5),
           ylim = c(-0,30)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = w_africa_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

w_africa_panel <-
  ggdraw() +
  draw_plot(w_africa_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(w_africa_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = w_africa_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```

## Western Central Pacific

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Western Central Pacific")

print(unique(selected_hotspot$name))

```

"The Gambia"      "Senegal"         "Guinea-Bissau"   "Guinea"          "Morocco (South)"


```{r wc_pacific_data, eval = T, echo = T}

# Oceans future data
wc_pacific <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(wc_pacific$eez_name))

# SAU shapefile data
wc_pacific_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(wc_pacific_sf$name)
length(unique(wc_pacific_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


wc_pacific_line <- wc_pacific %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,50),
                     breaks = seq(-100,50,25),
                     labels = c("< -100",seq(-75,25,25),"50")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = wc_pacific_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

wc_pacific_2050 <- wc_pacific %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(wc_pacific_2050$change,na.rm = T))
max_value <- ceiling(max(wc_pacific_2050$change,na.rm = T))


wc_pacific_map <- 
  wc_pacific_sf %>% 
  left_join(wc_pacific_2050,
            by = "name") %>% 
  st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(data = . %>% filter(name %in% c("Palau")),
                              aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  ggrepel::geom_label_repel(data = . %>% filter(!name %in% c("Palau")),
                            aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "black") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,6),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(130,210),
           ylim = c(-30,20)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = wc_pacific_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

wc_pacific_panel <-
  ggdraw() +
  draw_plot(wc_pacific_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(wc_pacific_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = wc_pacific_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```

## Melanesia

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Melanesia")

print(unique(selected_hotspot$name))

```

"Solomon Isl."     "Papua New Guinea" "Vanuatu"     

```{r melanesia_data, eval = T, echo = T}

# Oceans future data
melanesia <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(melanesia$eez_name))

# SAU shapefile data
melanesia_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(melanesia_sf$name)
length(unique(melanesia_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


melanesia_line <- melanesia %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,25),
                     breaks = seq(-100,25,25),
                     labels = c("< -100",seq(-75,0,25),"25")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = melanesia_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

melanesia_2050 <- melanesia %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(melanesia_2050$change,na.rm = T))
max_value <- ceiling(max(melanesia_2050$change,na.rm = T))


melanesia_map <- 
  melanesia_sf %>% 
  left_join(melanesia_2050,
            by = "name") %>% 
  st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(data = . %>% filter(name == "Vanuatu"),aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "black") +
  ggrepel::geom_label_repel(data = . %>% filter(name != "Vanuatu"),aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,6),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(130,180),
           ylim = c(-30,5)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = melanesia_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

melanesia_panel <-
  ggdraw() +
  draw_plot(melanesia_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(melanesia_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = melanesia_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```

## Eastern Mediterranean

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Eastern Mediterranean")

print(unique(selected_hotspot$name))

```

"Solomon Isl."     "Papua New Guinea" "Vanuatu"     

```{r east_med_data, eval = T, echo = T}

# Oceans future data
east_med <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(east_med$eez_name))

# SAU shapefile data
east_med_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(east_med_sf$name)
length(unique(east_med_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


east_med_line <- east_med %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  # View()
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,100),
                     breaks = seq(-100,100,25),
                     # labels = c("75",seq(-50,75,25),"100")
                     labels = c("< -100",seq(-75,75,25),"> 100")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = east_med_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

east_med_2050 <- east_med %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(east_med_2050$change,na.rm = T)) -1
max_value <- ceiling(max(east_med_2050$change,na.rm = T))


east_med_map <- 
  east_med_sf %>% 
  left_join(east_med_2050,
            by = "name") %>% 
  st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(data = . %>% filter(name %in% c("Montenegro")),
                              aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "black") +
  ggrepel::geom_label_repel(data = . %>% filter(!name %in% c("Montenegro")),
                            aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,2.5),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(10,40),
           ylim = c(30,50)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = east_med_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

east_med_panel <-
  ggdraw() +
  draw_plot(east_med_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(east_med_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = east_med_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```

## Tunisia

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Tunisia")

print(unique(selected_hotspot$name))

```

Tunisia

```{r tunisia_data, eval = T, echo = T}

# Oceans future data
tunisia <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(tunisia$eez_name))

# SAU shapefile data
tunisia_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(tunisia_sf$name)
length(unique(tunisia_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


tunisia_line <- tunisia %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  # View()
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-60,60),
                     breaks = seq(-60,60,30),
                     labels = seq(-60,60,30)
                     # labels = c("< -100",seq(-75,75,25),"> 100")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = tunisia_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

tunisia_2050 <- tunisia %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(tunisia_2050$change,na.rm = T)) 
max_value <- ceiling(max(tunisia_2050$change,na.rm = T))


tunisia_map <- 
  tunisia_sf %>% 
  left_join(tunisia_2050,
            by = "name") %>% 
  st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(#data = . %>% filter(name %in% c("Montenegro")),
                              aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  # ggrepel::geom_label_repel(data = . %>% filter(!name %in% c("Montenegro")),
  #                           aes(label = name, fill = change, geometry = geometry),
  #                             stat = "sf_coordinates",
  #                             min.segment.length = 1,
  #                             size = 2, color = "white") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,2.5),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(7,14),
           ylim = c(32,40)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = tunisia_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

tunisia_panel <-
  ggdraw() +
  draw_plot(tunisia_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(tunisia_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = tunisia_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```

## Latin America

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Latin America")

print(unique(selected_hotspot$name))

```

[1] "Honduras (Pacific)"  "El Salvador"         "Guatemala (Pacific)"


```{r lat_am_data, eval = T, echo = T}

# Oceans future data
lat_am <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(lat_am$eez_name))

# SAU shapefile data
lat_am_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(lat_am_sf$name)
length(unique(lat_am_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


lat_am_line <- lat_am %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  # View()
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,100),
                     breaks = seq(-100,100,25),
                     # labels = seq(-60,60,30)
                     labels = c("< -100",seq(-75,75,25),"> 100")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = lat_am_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

lat_am_2050 <- lat_am %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(lat_am_2050$change,na.rm = T)) 
max_value <- ceiling(max(lat_am_2050$change,na.rm = T))


lat_am_map <- 
  lat_am_sf %>% 
  left_join(lat_am_2050,
            by = "name") %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(data = . %>% filter(ssp == "126"),
                              aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "black") +
  ggrepel::geom_label_repel(data = . %>% filter(ssp == "585"),
                            aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,2.5),
                           guide = guide_colorbar(title.position = "top")
                       ) +
  my_ggtheme_m(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",leg_width = 4, leg_aline = 0.5) +
  theme(strip.text = element_text(size = 10, colour = "black")) +
  # theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(-95,-80),
           ylim = c(8,16)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = lat_am_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

lat_am_panel <-
  ggdraw() +
  draw_plot(lat_am_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(lat_am_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = lat_am_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```
## Ukraine

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Ukraine")

print(unique(selected_hotspot$name))

```

ukraine

```{r ukraine_data, eval = T, echo = T}

# Oceans future data
ukraine <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(ukraine$eez_name))

# SAU shapefile data
ukraine_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(ukraine_sf$name)
length(unique(ukraine_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


ukraine_line <- ukraine %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  # View()
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-60,60),
                     breaks = seq(-60,60,30),
                     labels = seq(-60,60,30)
                     # labels = c("< -100",seq(-75,75,25),"> 100")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = ukraine_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

ukraine_2050 <- ukraine %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(ukraine_2050$change,na.rm = T)) 
max_value <- ceiling(max(ukraine_2050$change,na.rm = T))


ukraine_map <- 
  ukraine_sf %>% 
  left_join(ukraine_2050,
            by = "name") %>% 
  # st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    # ggrepel::geom_label_repel(#data = . %>% filter(name %in% c("Montenegro")),
    #                           aes(label = name, fill = change, geometry = geometry),
    #                           stat = "sf_coordinates",
    #                           min.segment.length = 1,
    #                           size = 2, color = "white") +
  # ggrepel::geom_label_repel(data = . %>% filter(!name %in% c("Montenegro")),
  #                           aes(label = name, fill = change, geometry = geometry),
  #                             stat = "sf_coordinates",
  #                             min.segment.length = 1,
  #                             size = 2, color = "white") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,2.5),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(20,40),
           ylim = c(42,52)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = ukraine_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

ukraine_panel <-
  ggdraw() +
  draw_plot(ukraine_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(ukraine_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = ukraine_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```


## South China Seas

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "South China Seas")

print(unique(selected_hotspot$name))

```

[1] "Taiwan"        "China"         "Korea (South)"


```{r s_china_s_data, eval = T, echo = T}

# Oceans future data
s_china_s <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(s_china_s$eez_name))

# SAU shapefile data
s_china_s_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(s_china_s_sf$name)
length(unique(s_china_s_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


s_china_s_line <- s_china_s %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-50,50),
                     breaks = seq(-50,50,25),
                     # labels = c("< -100",seq(-75,25,25),"50")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = s_china_s_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

s_china_s_2050 <- s_china_s %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(s_china_s_2050$change,na.rm = T))
max_value <- ceiling(max(s_china_s_2050$change,na.rm = T))


min_x <- floor(st_bbox(s_china_s_sf)[1])
max_x <- ceiling(st_bbox(s_china_s_sf)[3])
min_y <- floor(st_bbox(s_china_s_sf)[2])
max_y <- ceiling(st_bbox(s_china_s_sf)[4])


s_china_s_map <- 
  s_china_s_sf %>% 
  left_join(s_china_s_2050,
            by = "name") %>% 
  # st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(data = . %>% filter(name %in% c("Taiwan")),
                              aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  ggrepel::geom_label_repel(data = . %>% filter(!name %in% c("Taiwan")),
                            aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "black") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,1),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  # coord_sf(xlim = c(107,134),
  #          ylim = c(3,40)
  #          ) +
  coord_sf(xlim = c(min_x,max_x),
           ylim = c(min_y,max_y)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = s_china_s_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

s_china_s_panel <-
  ggdraw() +
  draw_plot(s_china_s_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(s_china_s_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = s_china_s_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```

## Southeast Asia

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Southeast Asia")

print(unique(selected_hotspot$name))

```

[1] "Singapore" "Vietnam"   "Myanmar"  


```{r se_asia_data, eval = T, echo = T}

# Oceans future data
se_asia <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(se_asia$eez_name))

# SAU shapefile data
se_asia_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(se_asia_sf$name)
length(unique(se_asia_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


se_asia_line <- se_asia %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,60),
                     breaks = seq(-100,60,30),
                     labels = c("< -100",seq(-70,30,30),"60")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = se_asia_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

se_asia_2050 <- se_asia %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change)) %>% 
  mutate(name = ifelse(name == "Viet Nam", "Vietnam",name))


min_value <- round(min(se_asia_2050$change,na.rm = T))
max_value <- ceiling(max(se_asia_2050$change,na.rm = T))


min_x <- floor(st_bbox(se_asia_sf)[1])
max_x <- ceiling(st_bbox(se_asia_sf)[3])
min_y <- floor(st_bbox(se_asia_sf)[2])
max_y <- ceiling(st_bbox(se_asia_sf)[4])


se_asia_map <- 
  se_asia_sf %>% 
  left_join(se_asia_2050,
            by = "name") %>% 
  # st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(data = . %>% filter(name %in% c("Singapore")),
                              aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  ggrepel::geom_label_repel(data = . %>% filter(!name %in% c("Singapore")),
                            aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "black") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,1),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  # coord_sf(xlim = c(107,134),
  #          ylim = c(3,40)
  #          ) +
  coord_sf(xlim = c(min_x,max_x),
           ylim = c(min_y,max_y)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = se_asia_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

se_asia_panel <-
  ggdraw() +
  draw_plot(se_asia_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(se_asia_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = se_asia_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```

## Indonesia

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Indonesia")

print(unique(selected_hotspot$name))

```

[1] "Indonesia (Central)" "Indonesia (Eastern)"


```{r indonesia_data, eval = T, echo = T}

# Oceans future data
indonesia <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(indonesia$eez_name))

# SAU shapefile data
indonesia_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(indonesia_sf$name)
length(unique(indonesia_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


indonesia_line <- indonesia %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,60),
                     breaks = seq(-100,60,30),
                     labels = c("< -100",seq(-70,30,30),"60")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = indonesia_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

indonesia_2050 <- indonesia %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change)) %>% 
  mutate(name = ifelse(name == "Viet Nam", "Vietnam",name))


min_value <- round(min(indonesia_2050$change,na.rm = T))
max_value <- ceiling(max(indonesia_2050$change,na.rm = T))


min_x <- floor(st_bbox(indonesia_sf)[1])
max_x <- ceiling(st_bbox(indonesia_sf)[3])
min_y <- floor(st_bbox(indonesia_sf)[2])
max_y <- ceiling(st_bbox(indonesia_sf)[4])


indonesia_map <- 
  indonesia_sf %>% 
  left_join(indonesia_2050,
            by = "name") %>% 
  # st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(data = . %>% filter(ssp %in% c("585")),
                              aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  ggrepel::geom_label_repel(data = . %>% filter(ssp %in% c("126")),
                            aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "black") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,1),
                           guide = guide_colorbar(title.position = "top")
                       ) +
  my_ggtheme_m(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",leg_width = 4, leg_aline = 0.5) +
  theme(strip.text = element_text(size = 10, colour = "black")) +
  # theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  # coord_sf(xlim = c(107,134),
  #          ylim = c(3,40)
  #          ) +
  coord_sf(xlim = c(min_x,max_x),
           ylim = c(min_y,max_y)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = indonesia_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

indonesia_panel <-
  ggdraw() +
  draw_plot(indonesia_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(indonesia_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = indonesia_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```
