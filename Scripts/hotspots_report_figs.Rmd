---
title: "Untitled"
author: "Juliano Palacios-Abrantes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, results='hide', message=FALSE, echo = F}
library(MyFunctions)

packages <- c(
  "tidyverse",
  "cowplot",
  "wesanderson",
  "sf"
)

my_lib(packages)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)
```


# Get data for all

```{r get_data, eval = T}

# Future Oceans data
future_data <- my_path("R",name = "aggregated_data_all_spp.csv", read = T) 

# Hotspots data
hotspot_data <- my_path("D", name= "hotspots_data.csv", read = T)

# Sau map
sau_sf <- my_sf("SAU")

# 
# as.data.frame(sau_sf) %>% select(name) %>% View()


```

## Gulf of Guinea

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Gulf of Guinea")


```

Cameroon, Congo, DRC, Equatorial Guinea, Gabon, Nigeria, Sao Tome & Principe


```{r g_guinea_data, eval = T, echo = T}

# Oceans future data
g_guinea <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_name
  )

length(unique(g_guinea$eez_name))

# SAU shapefile data
g_guinea_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(g_guinea_sf$name)


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "red"
)


g_guinea_line <- g_guinea %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(data = g_guinea,
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(data = g_guinea,
              aes(
                x = as.numeric(year),
                ymax = per_change_rm+sd_per_change,
                ymin = per_change_rm-sd_per_change,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual(values = color_pallet) +
  scale_fill_manual(values = color_pallet) +
  scale_y_continuous(limits =c(-100,50),
                     breaks = c(-100,-50,0,50)
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = g_guinea_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

g_guinea_2050 <- g_guinea %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(g_guinea_2050$change,na.rm = T))
max_value <- ceiling(max(g_guinea_2050$change,na.rm = T))


g_guinea_map <- 
  g_guinea_sf %>% 
  left_join(g_guinea_2050,
            by = "name") %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  geom_sf_label(aes(label = name, fill = change), size = 2, color = "white") +
  # scale_color_viridis_b("% Change Relative to Historical Value\n(All species aggregated)") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,10),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(0,14),
           ylim = c(-7,7)) +
  facet_wrap(~ssp,
             labeller = labeller(ssp = c("126" = "SSP1-2.6",
                                         "585" = "SSP5-8.5"))
             )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = g_guinea_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

g_guinea_panel <-
  ggdraw() +
  draw_plot(g_guinea_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(g_guinea_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)


panel_name <- paste0(selected_hotspot$hotspot,"_panel.png")[1] 

ggsave(plot = g_guinea_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )



```

## West Africa

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "West Africa")

print(unique(selected_hotspot$eez_name))

```

"The Gambia"      "Senegal"         "Guinea-Bissau"   "Guinea"          "Morocco (South)"


```{r w_africa_data, eval = T, echo = T}

# Oceans future data
w_africa <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_name
  )

length(unique(w_africa$eez_name))

# SAU shapefile data
w_africa_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(w_africa_sf$name)
length(unique(w_africa_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "red"
)


w_africa_line <- w_africa %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,100),
                     breaks = seq(-100,100,25),
                     labels = c("< -100",seq(-75,75,25),">100")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = w_africa_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

w_africa_2050 <- w_africa %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(w_africa_2050$change,na.rm = T))
max_value <- ceiling(max(w_africa_2050$change,na.rm = T))


w_africa_map <- 
  w_africa_sf %>% 
  left_join(w_africa_2050,
            by = "name") %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  geom_sf_label(aes(label = name, fill = change), size = 2, color = "white") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,1),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(-25,-5),
           ylim = c(-0,30)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = w_africa_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

w_africa_panel <-
  ggdraw() +
  draw_plot(w_africa_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(w_africa_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = w_africa_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```

## Western Central Pacific

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Western Central Pacific")

print(unique(selected_hotspot$name))

```

"The Gambia"      "Senegal"         "Guinea-Bissau"   "Guinea"          "Morocco (South)"


```{r wc_pacific_data, eval = T, echo = T}

# Oceans future data
wc_pacific <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(wc_pacific$eez_name))

# SAU shapefile data
wc_pacific_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(wc_pacific_sf$name)
length(unique(wc_pacific_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


wc_pacific_line <- wc_pacific %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,50),
                     breaks = seq(-100,50,25),
                     labels = c("< -100",seq(-75,25,25),"50")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = wc_pacific_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

wc_pacific_2050 <- wc_pacific %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(wc_pacific_2050$change,na.rm = T))
max_value <- ceiling(max(wc_pacific_2050$change,na.rm = T))


wc_pacific_map <- 
  wc_pacific_sf %>% 
  left_join(wc_pacific_2050,
            by = "name") %>% 
  st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(data = . %>% filter(name %in% c("Palau")),
                              aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  ggrepel::geom_label_repel(data = . %>% filter(!name %in% c("Palau")),
                            aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "black") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,6),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(130,210),
           ylim = c(-30,20)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = wc_pacific_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

wc_pacific_panel <-
  ggdraw() +
  draw_plot(wc_pacific_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(wc_pacific_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = wc_pacific_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```

## Melanesia

```{r}

selected_hotspot <- hotspot_data %>% 
  filter(hotspot == "Melanesia")

print(unique(selected_hotspot$name))

```

"Solomon Isl."     "Papua New Guinea" "Vanuatu"     

```{r melanesia_data, eval = T, echo = T}

# Oceans future data
melanesia <- future_data %>% 
  filter(
    eez_name %in% selected_hotspot$eez_nam
  )

length(unique(melanesia$eez_name))

# SAU shapefile data
melanesia_sf <- sau_sf %>% 
  filter(
    name %in% selected_hotspot$name
  )

print(melanesia_sf$name)
length(unique(melanesia_sf$name))


```


### Line plot

```{r}

color_pallet <- c(
  wes_palette("Darjeeling1",5),
  wes_palette("Royal2",5),
  "grey"
)


melanesia_line <- melanesia %>% 
  mutate(
    ymax = ifelse(per_change_rm+sd_per_change > 100,100,per_change_rm+sd_per_change),
    ymin = ifelse(per_change_rm-sd_per_change < -100, -100, per_change_rm-sd_per_change)
  ) %>% 
  ggplot() +
  # geom_line(
  #   aes(
  #     x = as.numeric(year),
  #     y = mean_per_change,
  #     color = eez_name
  #   )
  # ) +
  geom_line(
            aes(
              x = as.numeric(year),
              y = per_change_rm,
              # group = eez_name,
              color = eez_name
            ),
            linewidth = 1.5
            # color = "black"
  ) +
  geom_ribbon(
              aes(
                x = as.numeric(year),
                ymax = ymax,
                ymin = ymin,
                fill = eez_name
              ),
              alpha = 0.3
  )  +
  # scale_color_viridis_d("Gulf of Guinea EEZ") +
  # scale_fill_viridis_d("Gulf of Guinea EEZ") +
  scale_color_manual("EEZ", values = color_pallet) +
  scale_fill_manual("EEZ", values = color_pallet) +
  scale_y_continuous(limits =c(-100,25),
                     breaks = seq(-100,25,25),
                     labels = c("< -100",seq(-75,0,25),"25")
                     
  ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "bottom",facet_tx_s = "0") +
  labs(
    x= "Year",
    y = "% Change Relative to Historical Value\n(All species aggregated)"
  ) +
  facet_wrap(~ssp)

line_name <- paste0(selected_hotspot$hotspot,"_lines.png")[1]

ggsave(plot = melanesia_line,
       filename = my_path("R", "hotspot_report", name = line_name),
       width = 8,
       height = 4
)

```


### Map figure

```{r}

melanesia_2050 <- melanesia %>% 
  filter(year >= 2020 & year <= 2039) %>% 
  group_by(name = eez_name, ssp) %>% 
  summarise(change = mean(mean_per_change))


min_value <- round(min(melanesia_2050$change,na.rm = T))
max_value <- ceiling(max(melanesia_2050$change,na.rm = T))


melanesia_map <- 
  melanesia_sf %>% 
  left_join(melanesia_2050,
            by = "name") %>% 
  st_shift_longitude() %>% 
  ggplot() +
  my_land_map(fill = "grey80") +
  geom_sf(aes(fill = change)) +
  # geom_sf_label(aes(label = name, fill = change), size = 1.5, color = "grey50") +
    ggrepel::geom_label_repel(data = . %>% filter(name == "Vanuatu"),aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "black") +
  ggrepel::geom_label_repel(data = . %>% filter(name != "Vanuatu"),aes(label = name, fill = change, geometry = geometry),
                              stat = "sf_coordinates",
                              min.segment.length = 1,
                              size = 2, color = "white") +
  scale_fill_viridis_b("% Change by 2030 Relative to Historical Value", 
                       limits = c(min_value,max_value),breaks = seq(min_value,max_value,6),
                           guide = guide_colorbar(title.position = "right", title.hjust = 0.5, barwidth = 1, barheight = 15)
                       ) +
  my_ggtheme_p(ax_tx_s = 9,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 10,leg_pos = "right",facet_tx_s = "10") +
  theme(legend.title = element_text(angle = 270, vjust = 0.5, hjust = 0.5))+
  labs(
    x= "Longitude",
    y = "Latitude"
  ) +
  coord_sf(xlim = c(130,180),
           ylim = c(-30,5)
           ) +
  facet_wrap(~ssp,
  labeller = labeller(ssp = c("126" = "SSP1-2.6",
  "585" = "SSP5-8.5"))
  )

map_name <- paste0(selected_hotspot$hotspot,"_map.png")[1]

ggsave(plot = melanesia_map,
       filename = my_path("R", "hotspot_report", name = map_name),
       width = 8,
       height = 4
)


```

### Pannel figure

```{r}

melanesia_panel <-
  ggdraw() +
  draw_plot(melanesia_map, x = 0, y = .50, height = .50, width = 1) +
  draw_plot(melanesia_line, x = 0, y = 0, height = .51, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .52, hjust = 0, vjust = 1, 
             size = 10)



panel_name <- paste0(selected_hotspot$hotspot,"_panel.jpg")[1] 

ggsave(plot = melanesia_panel,
       filename = my_path("R", "hotspot_report", name =panel_name), 
       width = 20,
       height = 20, 
       units = 'cm',
       dpi = 300
       )




```